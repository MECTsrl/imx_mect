export LC_ALL = C

# ###############################################################
#
# Build setup
#

# Version of the LTIB local file system skeleton package.
SKELL_LFS_VER := 1.18-2

TOOLCHAIN_FLAG := SOURCERY_GCC=1

# Export MECT_RFSDIR for use in Makefiles generated by qmake.
export MECT_RFSDIR = $(MECT_LTIB_RFSDIR)

MECT_LDIR := $(CURDIR)/localfs
MECT_SPECDIR := $(CURDIR)/rpm/SPECS

MECT_QMAKE = $(MECT_QT_INSTALL_DIR)/bin/qmake

MECT_SMP_FLAG := -j$(shell grep -c ^processor /proc/cpuinfo)

# Use ccache.
export PATH := /usr/lib/ccache:$(PATH)

# All build targets
MECT_ALL_TARGETS := \
	local_prepare \
	splash \
	cgic_work \
	ATCMcontrol_RunTimeSystem \
	mect_plugins \
	mect_apps \

ifneq ($(wildcard 4c_runtime/.*),)
MECT_ALL_TARGETS += 4c_runtime
endif

ifneq ($(wildcard factory_test/trunk/.*),)
MECT_ALL_TARGETS += factory_test
endif

ifneq ($(wildcard key_generator/trunk/.*),)
MECT_ALL_TARGETS += key_generator
endif

MECT_ALL_TARGETS += \
	factory_data \
	localfs_rpm \

# All clean targets
MECT_CLEAN_TARGETS := \
	local_prepare_clean \
	splash_clean \
	cgic_work_clean \
	ATCMcontrol_RunTimeSystem_clean \

ifneq ($(wildcard factory_test/trunk/.*),)
MECT_CLEAN_TARGETS += factory_test_clean
endif

ifneq ($(wildcard key_generator/trunk/.*),)
MECT_CLEAN_TARGETS += key_generator_clean
endif

MECT_CLEAN_TARGETS += \
	factory_data_clean \
	localfs_rpm_clean \

MECT_LOCAL_SPECS := \
	local.spec \
	local-ATCMcontrol_RunTimeSystem.spec \

ifneq ($(wildcard 4c_runtime/.*),)
MECT_LOCAL_SPECS += local-4c_runtime.spec
endif

MECT_LOCAL_SPECS := $(MECT_LOCAL_SPECS:%=$(MECT_SPECDIR)/%)


# ###############################################################
#
# Setup/build/deploy all projects
#

.PHONY: all
all: $(MECT_ALL_TARGETS)



# ###############################################################
#
# local_prepare
#

.PHONY: local_prepare
local_prepare: local_prepare_clean local_prepare_build local_prepare_install

.PHONY: local_prepare_build
local_prepare_build:
	mkdir -p $(MECT_LDIR)

.PHONY: local_prepare_install
local_prepare_install:
	sudo rpm --nodeps --root $(MECT_LDIR) --dbpath /var/lib/rpm --prefix / --ignorearch -Uvh --define '_tmppath /tmp/rpm' $(MECT_RPMBASEDIR)/RPMS/arm/skell-lfs-$(SKELL_LFS_VER).arm.rpm
	sudo chown -R $(USER) $(MECT_LDIR)
	sudo rm -rf $(MECT_LDIR)/var/lib/rpm
	-sudo rmdir $(MECT_LDIR)/var/lib
	-sudo rmdir $(MECT_LDIR)/var

.PHONY: local_prepare_clean
local_prepare_clean:
	sudo rm -rf $(MECT_LDIR)

# ###############################################################
#
# Project mect_plugins
#
# TODO Convert to LTIB package (depends on several Makefile variables).
#

.PHONY: mect_plugins
mect_plugins: mect_plugins_clean mect_plugins_build mect_plugins_install

.PHONY: mect_plugins_build
mect_plugins_build: MECT_PRJDIR := $(CURDIR)/mect_plugins
mect_plugins_build:
	test -n $(MECT_PRJDIR)
	tar cf $(MECT_RPMBASEDIR)/SOURCES/mect_plugins-$(MECT_BUILD_PLUGINSCRT_TAG).tar -C $(MECT_PRJDIR) --exclude=.git --transform='s/^\./mect_plugins-$(MECT_BUILD_PLUGINSCRT_TAG)/' .
	rpmbuild --define 'MECT_RFSDIR $(MECT_RFSDIR)' --define 'MECT_QMAKE $(MECT_QMAKE)' --define '_topdir $(MECT_RPMBASEDIR)' --dbpath $(MECT_RPMTMPDIR)/rpmdb --target arm --define '_target_cpu arm' --define '_arch arm' --define '_prefix /' --define '_rpmdir $(MECT_RPMBASEDIR)/RPMS' -bb --clean --rmsource $(MECT_SPECDIR)/mect_plugins.spec

.PHONY: mect_plugins_install
mect_plugins_install: MECT_PRJDIR := $(CURDIR)/mect_plugins
mect_plugins_install:
	test -n $(MECT_PRJDIR)
	-sudo $(MECT_RPMBIN) --root $(MECT_RFSDIR) --dbpath /var/lib/rpm -e --allmatches --nodeps --define '_tmppath /tmp/ltib' mect_plugins 2>/dev/null
	sudo $(MECT_RPMBIN) --root $(MECT_RFSDIR) --dbpath /var/lib/rpm --prefix / --ignorearch -ivh --force --excludedocs --define '_tmppath /tmp/ltib' $(MECT_RPMDIR)/mect_plugins-$(MECT_BUILD_PLUGINSCRT_TAG)-*.$(MECT_TARGET_ARCH).rpm

.PHONY: mect_plugins_clean
mect_plugins_clean: MECT_PRJDIR := $(CURDIR)/mect_plugins
mect_plugins_clean:
	test -n $(MECT_PRJDIR)
	-test -d $(MECT_PRJDIR) && $(MAKE) -C $(MECT_PRJDIR) distclean

# ###############################################################
#
# Project mect_apps
#
# TODO Convert to LTIB package (depends on several Makefile variables).
#

.PHONY: mect_apps
mect_apps: mect_apps_clean mect_apps_build mect_apps_install

.PHONY: mect_apps_build
mect_apps_build: MECT_PRJDIR := $(CURDIR)/mect_apps
mect_apps_build:
	test -n $(MECT_PRJDIR)
	tar cf $(MECT_RPMBASEDIR)/SOURCES/mect_apps-$(MECT_BUILD_APPSCRT_TAG).tar -C $(MECT_PRJDIR) --exclude=.git --transform='s/^\./mect_apps-$(MECT_BUILD_APPSCRT_TAG)/' .
	rpmbuild --define 'MECT_RFSDIR $(MECT_RFSDIR)' --define 'MECT_QMAKE $(MECT_QMAKE)' --define '_topdir $(MECT_RPMBASEDIR)' --dbpath $(MECT_RPMTMPDIR)/rpmdb --target arm --define '_target_cpu arm' --define '_arch arm' --define '_prefix /' --define '_rpmdir $(MECT_RPMBASEDIR)/RPMS' -bb --clean --rmsource $(MECT_SPECDIR)/mect_apps.spec

.PHONY: mect_apps_install
mect_apps_install: MECT_PRJDIR := $(CURDIR)/mect_apps
mect_apps_install:
	test -n $(MECT_PRJDIR)
	-sudo $(MECT_RPMBIN) --root $(MECT_RFSDIR) --dbpath /var/lib/rpm -e --allmatches --nodeps --define '_tmppath /tmp/ltib' mect_apps 2>/dev/null
	sudo $(MECT_RPMBIN) --root $(MECT_RFSDIR) --dbpath /var/lib/rpm --prefix / --ignorearch -ivh --force --excludedocs --define '_tmppath /tmp/ltib' $(MECT_RPMDIR)/mect_apps-$(MECT_BUILD_PLUGINSCRT_TAG)-*.$(MECT_TARGET_ARCH).rpm

.PHONY: mect_apps_clean
mect_apps_clean: MECT_PRJDIR := $(CURDIR)/mect_apps
mect_apps_clean:
	test -n $(MECT_PRJDIR)
	-test -d $(MECT_PRJDIR) && $(MAKE) -C $(MECT_PRJDIR) distclean

# ###############################################################
#
# Project splash
#

.PHONY: splash
splash: splash_clean splash_build splash_install

.PHONY: splash_build
splash_build: MECT_PRJDIR := $(CURDIR)/splash
splash_build:
	test -n $(MECT_PRJDIR)
	cd $(MECT_PRJDIR); $(MECT_QMAKE) -spec qws/linux-g++-mx
	$(MAKE) $(MECT_SMP_FLAG) -C $(MECT_PRJDIR)

.PHONY: splash_install
splash_install: MECT_PRJDIR := $(CURDIR)/splash
splash_install:
	test -n $(MECT_PRJDIR)
	install -D -m 0755 $(MECT_PRJDIR)/splash $(MECT_LDIR)/root/splash

.PHONY: splash_clean
splash_clean: MECT_PRJDIR := $(CURDIR)/splash
splash_clean:
	test -n $(MECT_PRJDIR)
	-test -d $(MECT_PRJDIR) && $(MAKE) -C $(MECT_PRJDIR) distclean

# ###############################################################
#
# Project cgic_work
#

.PHONY: cgic_work
cgic_work: cgic_work_clean cgic_work_build cgic_work_install

.PHONY: cgic_work_build
cgic_work_build: MECT_PRJDIR := $(CURDIR)/cgic_work
cgic_work_build:
	test -n $(MECT_PRJDIR)
	$(MAKE) $(MECT_SMP_FLAG) -C $(MECT_PRJDIR) $(MECT_TOOLCHAIN_FLAG)

.PHONY: cgic_work_install
cgic_work_install: MECT_PRJDIR := $(CURDIR)/cgic_work
cgic_work_install:
	test -n $(MECT_PRJDIR)
	$(MAKE) -C $(MECT_PRJDIR) $(MECT_TOOLCHAIN_FLAG) install

.PHONY: cgic_work_clean
cgic_work_clean: MECT_PRJDIR := $(CURDIR)/cgic_work
cgic_work_clean:
	test -n $(MECT_PRJDIR)
	-test -d $(MECT_PRJDIR) && $(MAKE) -C $(MECT_PRJDIR) $(MECT_TOOLCHAIN_FLAG) clobber

# ###############################################################
#
# Project ATCMcontrol_RunTimeSystem
#

.PHONY: ATCMcontrol_RunTimeSystem
ATCMcontrol_RunTimeSystem: ATCMcontrol_RunTimeSystem_clean ATCMcontrol_RunTimeSystem_build ATCMcontrol_RunTimeSystem_install

.PHONY: ATCMcontrol_RunTimeSystem_build
ATCMcontrol_RunTimeSystem_build: MECT_PRJDIR := $(CURDIR)/ATCMcontrol_RunTimeSystem
ATCMcontrol_RunTimeSystem_build:
	test -n $(MECT_PRJDIR)
	$(MAKE) -j1 -C $(MECT_PRJDIR) -f _fcrts.mak TARGET=4CPC DEBUG=0 PRODUCT="USE_CROSSTABLE" $(MECT_TOOLCHAIN_FLAG) MECT_ROOTFS='$(MECT_LTIB_RFSDIR)' MECT_CC_VERSION='$(MECT_CC_VERSION)' MECT_CC_DIRECTORY='$(MECT_CC_DIRECTORY)' MECT_CC_RADIX='$(MECT_CC_RADIX)' all

.PHONY: ATCMcontrol_RunTimeSystem_install
ATCMcontrol_RunTimeSystem_install: MECT_PRJDIR := $(CURDIR)/ATCMcontrol_RunTimeSystem
ATCMcontrol_RunTimeSystem_install:
	test -n $(MECT_PRJDIR)
	install -D -m 0755 $(MECT_PRJDIR)/bin/fcrts $(MECT_LDIR)/root/fcrts.ATCMcontrol_RunTimeSystem

.PHONY: ATCMcontrol_RunTimeSystem_clean
ATCMcontrol_RunTimeSystem_clean: MECT_PRJDIR := $(CURDIR)/ATCMcontrol_RunTimeSystem
ATCMcontrol_RunTimeSystem_clean:
	test -n $(MECT_PRJDIR)
	-test -d $(MECT_PRJDIR) && $(MAKE) -j1 -C $(MECT_PRJDIR) -f _fcrts.mak TARGET=4CPC DEBUG=0 PRODUCT="USE_CROSSTABLE" $(MECT_TOOLCHAIN_FLAG) MECT_ROOTFS='$(MECT_LTIB_RFSDIR)' MECT_CC_VERSION='$(MECT_CC_VERSION)' MECT_CC_DIRECTORY='$(MECT_CC_DIRECTORY)' MECT_CC_RADIX='$(MECT_CC_RADIX)' clobber

# ###############################################################
#
# Project 4c_runtime
#

.PHONY: 4c_runtime
4c_runtime: 4c_runtime_clean 4c_runtime_build 4c_runtime_install

.PHONY: 4c_runtime_build
4c_runtime_build: MECT_PRJDIR := $(CURDIR)/4c_runtime
4c_runtime_build:
	test -n $(MECT_PRJDIR)
	$(MAKE) -j1 -C $(MECT_PRJDIR) -f _fcrts.mak TARGET=4CPC DEBUG=0 PRODUCT="USE_CROSSTABLE" $(MECT_TOOLCHAIN_FLAG) MECT_ROOTFS='$(MECT_LTIB_RFSDIR)' MECT_CC_VERSION='$(MECT_CC_VERSION)' MECT_CC_DIRECTORY='$(MECT_CC_DIRECTORY)' MECT_CC_RADIX='$(MECT_CC_RADIX)' all

.PHONY: 4c_runtime_install
4c_runtime_install: MECT_PRJDIR := $(CURDIR)/4c_runtime
4c_runtime_install:
	test -n $(MECT_PRJDIR)
	install -D -m 0755 $(MECT_PRJDIR)/bin/fcrts $(MECT_LDIR)/root/fcrts.4c_runtime

.PHONY: 4c_runtime_clean
4c_runtime_clean: MECT_PRJDIR := $(CURDIR)/4c_runtime
4c_runtime_clean:
	test -n $(MECT_PRJDIR)
	-test -d $(MECT_PRJDIR) && $(MAKE) -j1 -C $(MECT_PRJDIR) -f _fcrts.mak TARGET=4CPC DEBUG=0 PRODUCT="USE_CROSSTABLE" $(MECT_TOOLCHAIN_FLAG) MECT_ROOTFS='$(MECT_LTIB_RFSDIR)' MECT_CC_VERSION='$(MECT_CC_VERSION)' MECT_CC_DIRECTORY='$(MECT_CC_DIRECTORY)' MECT_CC_RADIX='$(MECT_CC_RADIX)' clobber

# ###############################################################
#
# Project factory_data
#

.PHONY: factory_data
factory_data: factory_data_clean factory_data_build factory_data_install

.PHONY: factory_data_build
factory_data_build: MECT_PRJDIR := $(CURDIR)
factory_data_build:
	test -n $(MECT_PRJDIR)
	tar czvf $(MECT_PRJDIR)/factory_data.tar.gz --exclude=.svn --exclude=.git -C $(MECT_PRJDIR)/localfs .

.PHONY: factory_data_install
factory_data_install: MECT_PRJDIR := $(CURDIR)
factory_data_install:
	test -n $(MECT_PRJDIR)
	mv $(MECT_PRJDIR)/factory_data.tar.gz $(MECT_LDIR)

.PHONY: factory_data_clean
factory_data_clean: MECT_PRJDIR := $(CURDIR)
factory_data_clean:
	test -n $(MECT_PRJDIR)
	rm -f $(MECT_LDIR)/factory_data.tar.gz

# ###############################################################
#
# localfs_rpm
#

.PHONY: localfs_rpm
localfs_rpm: localfs_rpm_clean localfs_rpm_build localfs_rpm_install

.PHONY: localfs_rpm_build
localfs_rpm_build: MECT_PRJDIR := $(CURDIR)
localfs_rpm_build:
	test -n $(MECT_PRJDIR)

.PHONY: localfs_rpm_install
localfs_rpm_install: MECT_PRJDIR := $(CURDIR)
localfs_rpm_install:
	test -n $(MECT_PRJDIR)
	tar cjvf $(MECT_RPMBASEDIR)/SOURCES/local.tar.bz2 --exclude=.svn -C $(MECT_LDIR) .
	rm -rf $(MECT_RPMTMPDIR)/{*,.??*}
	for s in $(MECT_LOCAL_SPECS); do \
		rpmbuild --define '_topdir $(MECT_RPMBASEDIR)' --dbpath $(MECT_RPMTMPDIR)/rpmdb --target arm --define '_target_cpu arm' --define '_arch arm' --define '_prefix /' --define '_rpmdir $(MECT_RPMBASEDIR)/RPMS' -bb --clean $$s; \
	done

.PHONY: localfs_rpm_clean
localfs_rpm_clean: MECT_PRJDIR := $(CURDIR)
localfs_rpm_clean:
	test -n $(MECT_PRJDIR)

# ###############################################################
#
# Project factory_test
#

ifneq ($(wildcard factory_test/trunk/.*),)

.PHONY: factory_test
factory_test: factory_test_clean factory_test_build factory_test_install

.PHONY: factory_test_build
factory_test_build: MECT_PRJDIR := $(CURDIR)/factory_test/trunk
factory_test_build:
	test -n $(MECT_PRJDIR)
	cd $(MECT_PRJDIR); $(MECT_QMAKE) -spec qws/linux-g++-mx -config codesourcery
	$(MAKE) $(MECT_SMP_FLAG) -C $(MECT_PRJDIR)

.PHONY: factory_test_install
factory_test_install: MECT_PRJDIR := $(CURDIR)/factory_test/trunk
factory_test_install:
	test -n $(MECT_PRJDIR)
	install -D -m 755 $(MECT_PRJDIR)/factory_test $(MECT_LDIR)/root/factory_test

.PHONY: factory_test_clean
factory_test_clean: MECT_PRJDIR := $(CURDIR)/factory_test/trunk
factory_test_clean:
	test -n $(MECT_PRJDIR)
	-make -C $(MECT_PRJDIR) distclean
	make -C $(MECT_PRJDIR)/trama $(MECT_TOOLCHAIN_FLAG) distclean

endif

# ###############################################################
#
# Project key_generator
#

ifneq ($(wildcard key_generator/trunk/.*),)

.PHONY: key_generator
key_generator: key_generator_clean key_generator_build key_generator_install

.PHONY: key_generator_build
key_generator_build: MECT_PRJDIR := $(CURDIR)/key_generator/trunk
key_generator_build:
	test -n $(MECT_PRJDIR)
	cd $(MECT_PRJDIR); $(MECT_QMAKE) -spec qws/linux-g++-mx
	make $(MECT_SMP_FLAG) -C $(MECT_PRJDIR)

.PHONY: key_generator_install
key_generator_install: MECT_PRJDIR := $(CURDIR)/key_generator/trunk
key_generator_install:
	test -n $(MECT_PRJDIR)
	install -D -m 755 $(MECT_PRJDIR)/keyGenerator $(MECT_LDIR)/root/key_generator

.PHONY: key_generator_clean
key_generator_clean: MECT_PRJDIR := $(CURDIR)/key_generator/trunk
key_generator_clean:
	test -n $(MECT_PRJDIR)
	-make -C $(MECT_PRJDIR) distclean

endif



# ###############################################################
#
# Utilities
#

.PHONY: clean
clean: $(MECT_CLEAN_TARGETS)
	sudo rm -rf $(MECT_LDIR)
