export LC_ALL = C

# ###############################################################
#
# Build setup
#

# Version of the LTIB local file system skeleton package.
SKELL_LFS_VER := 1.18-2

# Export MECT_RFSDIR for use in Makefiles generated by qmake.
export MECT_RFSDIR = $(MECT_LTIB_RFSDIR)

MECT_LDIR := $(CURDIR)/localfs
MECT_SPECDIR := $(CURDIR)/rpmbuild/SPECS

# Use ccache.
export PATH := /usr/lib/ccache:$(PATH)

# All build targets
MECT_ALL_TARGETS := \
	local_prepare \

MECT_ALL_TARGETS += \
	localfs_rpm \

# All clean targets
MECT_CLEAN_TARGETS := \
	local_prepare_clean \

MECT_CLEAN_TARGETS += \
	localfs_rpm_clean \

MECT_LOCAL_SPECS := \
	local.spec \

MECT_LOCAL_SPECS := $(MECT_LOCAL_SPECS:%=$(MECT_SPECDIR)/%)


# ###############################################################
#
# Setup/build/deploy all projects
#

.PHONY: all
all: $(MECT_ALL_TARGETS)



# ###############################################################
#
# local_prepare
#

.PHONY: local_prepare
local_prepare: local_prepare_clean local_prepare_build local_prepare_install

.PHONY: local_prepare_build
local_prepare_build:
	mkdir -p $(MECT_LDIR)

.PHONY: local_prepare_install
local_prepare_install:
	test -n "$(LOGNAME)"
	sudo rpm --nodeps --root $(MECT_LDIR) --dbpath /var/lib/rpm --prefix / --ignorearch -Uvh --define '_tmppath /tmp/rpm' $(MECT_RPMBASEDIR)/RPMS/arm/skell-lfs-$(SKELL_LFS_VER).arm.rpm
	sudo chown -R $(LOGNAME) $(MECT_LDIR)
	sudo rm -rf $(MECT_LDIR)/var/lib/rpm
	-sudo rmdir $(MECT_LDIR)/var/lib
	-sudo rmdir $(MECT_LDIR)/var

.PHONY: local_prepare_clean
local_prepare_clean:
	sudo rm -rf $(MECT_LDIR)

# ###############################################################
#
# localfs_rpm
#

.PHONY: localfs_rpm
localfs_rpm: localfs_rpm_clean localfs_rpm_build localfs_rpm_install

.PHONY: localfs_rpm_build
localfs_rpm_build: MECT_PRJDIR := $(CURDIR)
localfs_rpm_build:
	test -n "$(MECT_PRJDIR)"

.PHONY: localfs_rpm_install
localfs_rpm_install: MECT_PRJDIR := $(CURDIR)
localfs_rpm_install:
	test -n "$(MECT_PRJDIR)"
	test -n "$(MECT_TMPRPMDIR)"
	tar cjvf $(MECT_RPMBASEDIR)/SOURCES/local.tar.bz2 --exclude=.svn -C $(MECT_LDIR) .
	rm -rf $(MECT_TMPRPMDIR)/{*,.??*}
	for s in $(MECT_LOCAL_SPECS); do \
		rpmbuild --define '_topdir $(MECT_RPMBASEDIR)' --dbpath $(MECT_TMPRPMDIR)/rpmdb --target arm --define '_target_cpu arm' --define '_arch arm' --define '_prefix /' --define '_rpmdir $(MECT_RPMBASEDIR)/RPMS' -bb --clean $$s; \
	done

.PHONY: localfs_rpm_clean
localfs_rpm_clean: MECT_PRJDIR := $(CURDIR)
localfs_rpm_clean:
	test -n "$(MECT_PRJDIR)"



# ###############################################################
#
# Utilities
#

.PHONY: clean
clean: $(MECT_CLEAN_TARGETS)
