#! @testdir@/xeno-test-run

usage()
{
    cat <<EOF
xeno-regression-test [ -l "load command" ] [ -- ] [ latency test options ]

Run Xenomai regression testsuite on your platform, by first starting a
fewtests, then running the latency test in parallel to the switchtest test
under the load generated by "load-command".

By default, the load command is "dohell 900", which will generate load during
15 minutes. To generate a more realistic load see dohell help.

Any other option passed on the command line is passed to the latency test.

Example:
xeno-regression-test -l "dohell -s 192.168.0.5 -m /mnt -l /ltp" -t 2

Will generate load including network load using the server at IP address
192.168.0.5, some I/O under the moint point /mnt, and the LTP testsuite
installed under the /ltp directory, and use the latency test by measuring the
timer irq latency.
EOF
}

if [ "$1" = "-h" -o "$1" = "--help" ]; then
    usage
    exit 0
fi

if [ "$1" = "--" ]; then
   shift
fi

set -ex

echo 0 > /proc/xenomai/latency || :

# in-tree tests
@testdir@/arith
@testdir@/clocktest -T 30
@testdir@/cond-torture-native
@testdir@/cond-torture-posix
@testdir@/mutex-torture-native
@testdir@/mutex-torture-posix

# the tests in this tree
@pkgdir@/regression/posix/leaks
@pkgdir@/regression/posix/shm
@pkgdir@/regression/native/heap
@pkgdir@/regression/native/leaks
@pkgdir@/regression/native/mayday
@pkgdir@/regression/native/tsc
@pkgdir@/regression/native+posix/mq_select

start_load

check_alive @testdir@/switchtest
check_alive @testdir@/switchtest -s 1000
check_alive @testdir@/latency ${1+"$@"}

wait_load
