--- ltib/dist/lfs-5.1/base_libs/base_libs.spec	2013-01-09 04:58:38.000000000 +0100
+++ ltib.new/dist/lfs-5.1/base_libs/base_libs.spec	2015-10-12 10:46:10.534468000 +0200
@@ -11,6 +11,17 @@
 Group           : System Environment/Libraries
 BuildRoot       : %{_tmppath}/%{name}
 Prefix          : %{pfx}
+AutoReqProv     : no
+
+
+%Package rfs
+Summary         : Trimmed base_libs for root file system requirements.
+Group           : Applications/File
+AutoReqProv     : no
+%Description rfs
+base_libs package contents restricted to just the files that
+are needed at run time on the target.
+
 
 %Description
 %{summary}
@@ -35,7 +46,7 @@
 # strip "bin/"
 set +e
 ${TOOLCHAIN_PREFIX}gcc -v 2>&1 | grep -q "prefix=/usr"
-if (( $? ))
+if test $? -ne 0
 then
 TC_PREFIX="`which ${TOOLCHAIN_PREFIX}gcc | perl -p -e 's,/bin/'${TOOLCHAIN_PREFIX}'gcc,,'`"
 else
@@ -45,6 +56,7 @@
 
 
 %Install
+set -x
 rm -rf $RPM_BUILD_ROOT
 X_DIR=`echo $TOOLCHAIN_PREFIX | sed -e 's,-$,,'`
 
@@ -53,7 +65,7 @@
 # strip "bin/"
 set +e
 ${TOOLCHAIN_PREFIX}gcc -v 2>&1 | grep -q "prefix=/usr"
-if (( $? ))
+if test $? -ne 0
 then
 TC_PREFIX="`which ${TOOLCHAIN_PREFIX}gcc | perl -p -e 's,/bin/'${TOOLCHAIN_PREFIX}'gcc,,'`"
 SYSROOT_TC="no"
@@ -122,12 +134,12 @@
     #       is a symbolic link to lib! - Stevep
     if [ "${TC_TYPE}" != "UCLIBC" ]
     then
-        cp -dp $SHARED_LIBS_DIR/../usr/lib/*.so* $RPM_BUILD_ROOT/%{pfx}/usr/lib/
+        cp -dp $SHARED_LIBS_DIR/../usr/lib/*.so* $RPM_BUILD_ROOT/%{pfx}%{_prefix}/lib/
     fi
     rm -f $RPM_BUILD_ROOT/%{pfx}/lib/libstdc++*.so*
-    rm -f $RPM_BUILD_ROOT/%{pfx}/usr/lib/libstdc++*.so*
+    rm -f $RPM_BUILD_ROOT/%{pfx}%{_prefix}/lib/libstdc++*.so*
     rm -f $RPM_BUILD_ROOT/%{pfx}/lib/libgcc*.so*
-    rm -f $RPM_BUILD_ROOT/%{pfx}/usr/lib/libgcc*.so*
+    rm -f $RPM_BUILD_ROOT/%{pfx}%{_prefix}/lib/libgcc*.so*
 
     # Only needed if gcc native is selected.
     #
@@ -157,9 +169,9 @@
         do
             if [ "$TC_TYPE" = "XTOOL" ]
             then
-                cp -dpf $TC_PREFIX/$X_DIR/$i/bin/${file} $RPM_BUILD_ROOT/%{pfx}/usr/bin
+                cp -dpf $TC_PREFIX/$X_DIR/$i/bin/${file} $RPM_BUILD_ROOT/%{pfx}%{_prefix}/bin
             else
-                cp -dpf $TC_PREFIX/$X_DIR/$i/usr/bin/${file} $RPM_BUILD_ROOT/%{pfx}/usr/bin
+                cp -dpf $TC_PREFIX/$X_DIR/$i/usr/bin/${file} $RPM_BUILD_ROOT/%{pfx}%{_prefix}/bin
             fi
         done
         for file in ldconfig sln
@@ -170,54 +182,54 @@
         do
             if [ "$TC_TYPE" = "XTOOL" ]
             then
-                cp -dpf $TC_PREFIX/$X_DIR/$i/sbin/${file} $RPM_BUILD_ROOT/%{pfx}/usr/sbin
+                cp -dpf $TC_PREFIX/$X_DIR/$i/sbin/${file} $RPM_BUILD_ROOT/%{pfx}%{_prefix}/sbin
             else
-                cp -dpf $TC_PREFIX/$X_DIR/$i/usr/sbin/${file} $RPM_BUILD_ROOT/%{pfx}/usr/sbin
+                cp -dpf $TC_PREFIX/$X_DIR/$i/usr/sbin/${file} $RPM_BUILD_ROOT/%{pfx}%{_prefix}/sbin
             fi
         done
     else
-        cp $TC_PREFIX/$X_DIR/$i/target_utils/ldd $RPM_BUILD_ROOT/%{pfx}/usr/bin
+        cp $TC_PREFIX/$X_DIR/$i/target_utils/ldd $RPM_BUILD_ROOT/%{pfx}%{_prefix}/bin
     fi
     set -e
 fi
 
 if [ -n "$PKG_LIBC_WANT_CRT_FILES" ]
 then 
-    cp -dp $CRT_FILES_DIR/*crt*.o $RPM_BUILD_ROOT/%{pfx}/usr/lib/
+    cp -dp $CRT_FILES_DIR/*crt*.o $RPM_BUILD_ROOT/%{pfx}%{_prefix}/lib/
 fi
 
 if [ -n "$PKG_LIBC_WANT_HEADERS1" ]
 then
     if [ "$TC_TYPE" = "CSL" ]
     then 
-        cp -a $TC_PREFIX/$X_DIR/libc/usr/include $RPM_BUILD_ROOT/%{pfx}/usr
+        cp -a $TC_PREFIX/$X_DIR/libc/usr/include $RPM_BUILD_ROOT/%{pfx}%{_prefix}
     elif [ "$TC_TYPE" = "EGLIBC" ]
     then
-        cp -a $TC_PREFIX/$X_DIR/sysroot/usr/include $RPM_BUILD_ROOT/%{pfx}/usr
+        cp -a $TC_PREFIX/$X_DIR/sysroot/usr/include $RPM_BUILD_ROOT/%{pfx}%{_prefix}
     elif [ "$TC_TYPE" = "XTOOL-SYSROOT" ]
     then
-        cp -a $TC_PREFIX/$X_DIR/sys-root/usr/include $RPM_BUILD_ROOT/%{pfx}/usr
+        cp -a $TC_PREFIX/$X_DIR/sys-root/usr/include $RPM_BUILD_ROOT/%{pfx}%{_prefix}
     elif [ "${TC_TYPE}" = "UCLIBC-SYSROOT" ]
     then
-        cp -a ${TC_PREFIX}/usr/include ${RPM_BUILD_ROOT}/%{pfx}/usr
+        cp -a ${TC_PREFIX}/usr/include ${RPM_BUILD_ROOT}/%{pfx}%{_prefix}
     else
         for i in $TC_PREFIX/$X_DIR/include $TC_PREFIX/include
         do
             if [ -f $i/stdio.h ]
             then
-                cp -a $i $RPM_BUILD_ROOT/%{pfx}/usr
+                cp -a $i $RPM_BUILD_ROOT/%{pfx}%{_prefix}
                 break
             fi
         done
-        rm -rf $RPM_BUILD_ROOT/%{pfx}/usr/include/c++
+        rm -rf $RPM_BUILD_ROOT/%{pfx}%{_prefix}/include/c++
     fi
 fi
 
 if [ -n "$PKG_LIBC_WANT_STATIC_LIBS" ]
 then 
-    cp -dp $STATIC_LIBS_DIR/*.a $RPM_BUILD_ROOT/%{pfx}/usr/lib/
-    rm -f $RPM_BUILD_ROOT/%{pfx}/usr/lib/libstdc++*a*
-    rm -f $RPM_BUILD_ROOT/%{pfx}/usr/lib/libsupc++*a*
+    cp -dp $STATIC_LIBS_DIR/*.a $RPM_BUILD_ROOT/%{pfx}%{_prefix}/lib/
+    rm -f $RPM_BUILD_ROOT/%{pfx}%{_prefix}/lib/libstdc++*a*
+    rm -f $RPM_BUILD_ROOT/%{pfx}%{_prefix}/lib/libsupc++*a*
 fi
 
 if [ -n "$PKG_LIBC_WANT_C_LOCALES" ]
@@ -225,7 +237,7 @@
     set +e
     if [ -n "$UCLIBC" ]
     then
-        cp -a $TC_PREFIX/usr/share/locale $RPM_BUILD_ROOT/%{pfx}/usr/share
+        cp -a $TC_PREFIX/usr/share/locale $RPM_BUILD_ROOT/%{pfx}%{_prefix}/share
     else
         if [ "$TC_TYPE" = "CSL" ]
         then
@@ -241,16 +253,16 @@
             i=
         fi
 
-        cp -a $TC_PREFIX/$X_DIR/$i/lib/locale $RPM_BUILD_ROOT/%{pfx}/usr/lib
-        cp -a $TC_PREFIX/$X_DIR/$i/info $RPM_BUILD_ROOT/%{pfx}/usr
-        cp -a $TC_PREFIX/$X_DIR/$i/share/locale $RPM_BUILD_ROOT/%{pfx}/usr/share
-        cp -a $TC_PREFIX/$X_DIR/$i/share/i18n $RPM_BUILD_ROOT/%{pfx}/usr/share
-        cp -a $TC_PREFIX/$X_DIR/$i/share/zoneinfo $RPM_BUILD_ROOT/%{pfx}/usr/share
+        cp -a $TC_PREFIX/$X_DIR/$i/lib/locale $RPM_BUILD_ROOT/%{pfx}%{_prefix}/lib
+        cp -a $TC_PREFIX/$X_DIR/$i/info $RPM_BUILD_ROOT/%{pfx}%{_prefix}
+        cp -a $TC_PREFIX/$X_DIR/$i/share/locale $RPM_BUILD_ROOT/%{pfx}%{_prefix}/share
+        cp -a $TC_PREFIX/$X_DIR/$i/share/i18n $RPM_BUILD_ROOT/%{pfx}%{_prefix}/share
+        cp -a $TC_PREFIX/$X_DIR/$i/share/zoneinfo $RPM_BUILD_ROOT/%{pfx}%{_prefix}/share
         for j in tzselect locale localedef
         do
-            cp -a $TC_PREFIX/$X_DIR/$i/bin/$j $RPM_BUILD_ROOT/%{pfx}/usr/bin/
+            cp -a $TC_PREFIX/$X_DIR/$i/bin/$j $RPM_BUILD_ROOT/%{pfx}%{_prefix}/bin/
         done
-        cp -a $TC_PREFIX/$X_DIR/$i/$SLIBS/gconv $RPM_BUILD_ROOT/%{pfx}/usr/lib/
+        cp -a $TC_PREFIX/$X_DIR/$i/$SLIBS/gconv $RPM_BUILD_ROOT/%{pfx}%{_prefix}/lib/
     fi
     set -e
 fi
@@ -277,13 +289,13 @@
     else
         i= 
     fi
-    cp -a $TC_PREFIX/$i/include/c++ $RPM_BUILD_ROOT/%{pfx}/usr/include
+    cp -a $TC_PREFIX/$i/include/c++ $RPM_BUILD_ROOT/%{pfx}%{_prefix}/include
 fi
 
 if [ -n "$PKG_CXX_WANT_STATIC_LIBS" ]
 then 
-    cp -dp $CPP_LIB_DIR/libstdc++*.a $RPM_BUILD_ROOT/%{pfx}/usr/lib/
-    cp -dp $CPPSUP_LIB_DIR/libsupc++*.a $RPM_BUILD_ROOT/%{pfx}/usr/lib/
+    cp -dp $CPP_LIB_DIR/libstdc++*.a $RPM_BUILD_ROOT/%{pfx}%{_prefix}/lib/
+    cp -dp $CPPSUP_LIB_DIR/libsupc++*.a $RPM_BUILD_ROOT/%{pfx}%{_prefix}/lib/
 fi
 
 if [ -n "$PKG_GCC_WANT_LIBGCC_SHARED" ]
@@ -296,7 +308,7 @@
 
 # remove absolute paths from text search files (if they exist)
 perl -w -e '
-    @ARGV = grep { `file $_` =~ m,ASCII C program text, } @ARGV;
+    @ARGV = grep { `file $_` =~ m,ASCII\s+.*text, } @ARGV;
     exit(0) unless @ARGV;
     $^I = ".bak";
     while(<>) {
@@ -305,14 +317,14 @@
     }
     ' $RPM_BUILD_ROOT/%{pfx}/lib/libc.so \
       $RPM_BUILD_ROOT/%{pfx}/lib/libpthread.so \
-      $RPM_BUILD_ROOT/%{pfx}/usr/lib/libc.so \
-      $RPM_BUILD_ROOT/%{pfx}/usr/lib/libpthread.so
+      $RPM_BUILD_ROOT/%{pfx}%{_prefix}/lib/libc.so \
+      $RPM_BUILD_ROOT/%{pfx}%{_prefix}/lib/libpthread.so
 
 cd $RPM_BUILD_ROOT/%{pfx}
 # this is necessary to avoid annoying warnings from ldd about no execute
 # permissions for some malformed uClibc toolchains
 find $RPM_BUILD_ROOT/%{pfx}/lib     | xargs chmod 755
-find $RPM_BUILD_ROOT/%{pfx}/usr/lib | xargs chmod 755
+find $RPM_BUILD_ROOT/%{pfx}%{_prefix}/lib | xargs chmod 755
 
 # relocate all symlink .so (linker files) to usr/lib
 cd lib
@@ -333,9 +345,19 @@
    }
 ' 
 
+cd %{_builddir}
+( cd $RPM_BUILD_ROOT; find .%{pfx} \( \( -not -type d \) -o \( -type d -empty \) \) -print | sed 's/^\.//' ) > all_files.lst
+sed '
+    \,%{pfx}%{_includedir}, d;
+    \,\.bak$, d;
+' all_files.lst > rfs_files.lst
+
 %Clean
 rm -rf $RPM_BUILD_ROOT
 
-%Files
+%Files -f all_files.lst
+%defattr(-,root,root)
+
+
+%Files rfs -f rfs_files.lst
 %defattr(-,root,root)
-%{pfx}/*
