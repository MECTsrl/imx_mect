--- ltib/config/platform/imx/kernel-2.6.35.spec.in	2015-09-22 13:05:57.000000000 +0200
+++ ltib.new/config/platform/imx/kernel-2.6.35.spec.in	2015-09-25 15:14:57.093929000 +0200
@@ -2,6 +2,8 @@
 
 %define pfx /opt/freescale/rootfs/%{_target_cpu}
 %define pkg_name linux
+%define x_name   xenomai
+%define x_ver    2.6.0
 
 Summary         : Linux kernel (core of the Linux operating system)
 Name            : kernel
@@ -12,22 +14,185 @@
 Packager        : Rob Herring
 Group           : System Environment/Kernel
 Source          : %{pkg_name}-%{version}.tar.bz2
-Source1         : %{pkg_name}-%{version}-%{release}.bz2
+# Archive superseeded by Patch0 from Francesco
+#Source1         : %{pkg_name}-%{version}-%{release}.bz2
+Source2         : %{x_name}-%{x_ver}.tar.bz2
 URL             : http://www.kernel.org/
+# Freescale patch from Francesco, equivalent to %{pkg_name}-%{version}-%{release}.bz2
+Patch0          : %{pkg_name}-2.6-imx_rel_imx_2.6.35_11.01.00.patch
+
+# MECT patches (2012)
+Patch1          : %{name}-%{version}-1310041712.patch
+Patch2          : %{name}-%{version}-1310035700.patch
+Patch3          : %{name}-%{version}-1310028574.patch
+Patch4          : %{name}-%{version}-1316603523.patch
+Patch5          : %{name}-%{version}-1316009304.patch
+Patch6          : %{name}-%{version}-1317998791.patch
+Patch7          : %{name}-%{version}-1318337806.patch
+Patch8          : %{name}-%{version}-1318495408.patch
+Patch9          : %{name}-%{version}-1319702741.patch
+Patch10         : %{name}-%{version}-1329224069.patch
+Patch11         : %{name}-%{version}-1332171148.patch
+Patch12         : %{name}-%{version}-1333040073.patch
+Patch13         : %{name}-%{version}-1337754222.patch
+Patch14         : %{name}-%{version}-1348834818.patch
+Patch15         : %{name}-%{version}-1352446729.patch
+Patch16         : %{name}-%{version}-1353925535.patch
+Patch17         : %{name}-%{version}-1355490258.patch
+Patch18         : %{name}-%{version}-1359385592.patch
+Patch19         : %{name}-%{version}-1364380255.patch
+Patch20         : %{name}-%{version}-1366295778.patch
+
+# MECT patches
+Patch21         : %{name}-%{version}-1367838157.patch
+Patch22         : %{name}-%{version}-1367915669.patch
+Patch23         : %{name}-%{version}-1368026104.patch
+Patch24         : %{name}-%{version}-1374825662.patch
+Patch25         : %{name}-%{version}-1382692579.patch
+Patch26         : %{name}-%{version}-1389885832.patch
+Patch27         : %{name}-%{version}-1391688299.patch
+Patch28         : %{name}-%{version}-1406105822.patch
+Patch29         : %{name}-%{version}-1410159845.patch
+Patch30         : %{name}-%{version}-1412763299.patch
+Patch31         : %{name}-%{version}-1417086426.patch
+Patch32         : %{name}-%{version}-1417857461.patch
+Patch33         : %{name}-%{version}-1428042966.patch
+
+# Xenomai 2.6.0 patches
+# Patch kernel for Adeos I-pipe
+Patch34         : %{pkg_name}-2.6-imx_rel_imx_2.6.35_11.01.00_mect2.patch
+Patch35         : %{pkg_name}-2.6-imx_rel_imx_2.6.35_11.01.00_mect3-mtl.patch
+# Patch Xenomai
+Patch36         : %{x_name}-%{x_ver}_mect3.patch
+# Kernel patches for monitoring using GPIO
+#Patch37         : %{pkg_name}-%{version}_ipipe_2012_07_11_timer_match.patch
+# Patch Xenomai
+#Patch38         : %{x_name}-%{x_ver}+flexcan_all_in_one_final.patch
+Patch39         : %{x_name}-%{x_ver}-fix-scriptpath-calculation.patch
+
+# Generic kernel patches
+Patch40         : %{name}-%{version}-mxs_reset_block-undefined.patch
 BuildRoot       : %{_tmppath}/%{name}
 Prefix          : %{pfx}
+AutoReqProv     : no
 
+
+%Package rfs
+Summary         : Trimmed kernel for root file system requirements.
+Group           : Applications/File
+AutoReqProv     : no
+%Description rfs
+kernel package contents restricted to just the files that are
+needed at run time on the target.
+
+
+# %{name}-%{version}-1310041712.patch : Fix the ethernet plug/unplug problem
+# %{name}-%{version}-1310035700.patch : added the Mect logo in the logo lists
+# %{name}-%{version}-1310028574.patch : enable keyboard GPIO using the module gpio-keys for the Mect project
+# %{name}-%{version}-1316603523.patch : Add the RTS control
+# %{name}-%{version}-1316009304.patch : Added support for TIANMA 4.3 LCD Display
+# %{name}-%{version}-1317998791.patch : Added support for buzzer as char device /dev/buzzer and patched gpio_keyboard driver
+# %{name}-%{version}-1318337806.patch : export the buzzer header to be visible for the user space
+# %{name}-%{version}-1318495408.patch : Added in the power fail detect module, the code to get the PLC application pid and the code to send to it the signal 
+# %{name}-%{version}-1319702741.patch : Disabled the standby display, modify the logo to 480x272 and solved the recovery ubifs bug
+# %{name}-%{version}-1329224069.patch : Fix liminance range of tm043, introduce the config key MECT_CUSTOMIZATION, fix the keyboard press&release problem, fix the LAN problem, fix the CAN power on/off problem
+# %{name}-%{version}-1332171148.patch : Add support for PENMOUNT driver. Modified power support to gracefully shutdown, added ele01 and val01 customization keyword for lan, wifi.
+# %{name}-%{version}-1333040073.patch : Fixed a bug in lan enable management
+# %{name}-%{version}-1337754222.patch : Add support for HITACHI 5.7 LCD Display
+# %{name}-%{version}-1348834818.patch : Introduced Kconfig keys for TPAC1006, U295, added boot logo for all currently managed projects, modified buzzer driver to choose beside duration also duty cycle for VAL01 project. Patched the lcdif clock source to be compliant with display requirements and managed LCD_ENABLE signal as required by the different supported displays.
+# %{name}-%{version}-1352446729.patch : freescale patch to solve trouble with some eth0 that won't start
+# %{name}-%{version}-1353925535.patch : configure lan enable according to the new hardware requirement
+# %{name}-%{version}-1355490258.patch : changed frequency for VAL01 buzzer and added patch to avoid kernel bug in gspca driver
+# %{name}-%{version}-1359385592.patch : added support for Hitachi LCD 5.7" 640x480 pixel
+# %{name}-%{version}-1364380255.patch: fixed polarity of dotclock for TIANMA4.3' monitor 
+# %{name}-%{version}-1366295778.patch: added support for ROCKTECH 4.3" display
+# %{name}-%{version}-1367838157.patch: retentive support for ATN01 project
+# %{name}-%{version}-1367915669.patch: added CONFIG_MECT_ATN01 keyword and logo for ATN01 project
+# %{name}-%{version}-1368026104.patch: added support for I2C RS5C372 chip through GPIO for VAL01 project
+# %{name}-%{version}-1374825662.patch: added support for DS1390 RTC chip device
+# %{name}-%{version}-1382692579.patch: fixed RS485 behaviour in order to stop rx while transmitting, working half duplex
+# %{name}-%{version}-1389885832.patch: fixed LAN phy driver to work also when a direct connection (i.e. without a switch device) exists
+# %{name}-%{version}-1391688299.patch: Added support for Formike LCD 7" display driven by ref_xtal
+# %{name}-%{version}-1406105822.patch: Added support for TPAC1006 at power fail, uploaded various mect logo and changed logo for atn01
+# %{name}-%{version}-1410159845.patch: Patched gpmi-nand driver to deal with bitflips in erased regions (corrupt empty space LEB error)
+# %{name}-%{version}-1412763299.patch: Added check to get ref_gpmi as FLASH clock if configured so by bootlets.
 %Description
 %{summary}
 
 %Prep
 %define buildsubdir %{pkg_name}-%{version}
+%define x_dir    %{buildsubdir}-%{x_name}-%{x_ver}
+%define x_subdir %{x_name}-%{x_ver}
 KSRC_DIR=${PKG_KERNEL_PATH_PRECONFIG:-%{_builddir}/%{buildsubdir}}
 
 if [ -z "$PKG_KERNEL_LEAVESRC" ] || [ ! -d "$KSRC_DIR" ]
 then
-%setup -n %{buildsubdir} -a 1
-chmod 755 patches/patch-kernel.sh
-./patches/patch-kernel.sh
+# Patches from the archive are superseeded by Francesco's Patch0
+#%setup -a 1 -n %{buildsubdir}
+#chmod 755 patches/patch-kernel.sh
+#./patches/patch-kernel.sh
+:
 fi
+# Unpack Xenomai source tree
+%setup -T -a 2 -c -n %{x_dir}
+%setup -T -D -b 0 -n %{buildsubdir}
+
+%patch0 -p1
+%patch1 -p1
+%patch2 -p1
+%patch3 -p1
+%patch4 -p1
+%patch5 -p1
+%patch6 -p1
+%patch7 -p1
+%patch8 -p1
+%patch9 -p1
+%patch10 -p1
+%patch11 -p1
+%patch12 -p1
+%patch13 -p1
+%patch14 -p1
+%patch15 -p1
+%patch16 -p1
+%patch17 -p1
+%patch18 -p1
+%patch19 -p1
+%patch20 -p1
+%patch21 -p1
+%patch22 -p1
+%patch23 -p1
+%patch24 -p1
+%patch25 -p1
+%patch26 -p1
+%patch27 -p1
+%patch28 -p1
+%patch29 -p1
+%patch30 -p1
+%patch31 -p1
+%patch32 -p1
+%patch33 -p1
+
+%patch34 -p1
+%patch35 -p1
+
+# Patch Xenomai
+cd %{_builddir}/%{x_dir}/%{x_name}-%{x_ver}
+%patch36 -p1
+%patch39 -p1
+cd %{_builddir}/%{buildsubdir}
+
+# Setup the kernel for Xenomai
+cd %{_builddir}/%{x_dir}
+sh %{x_name}-%{x_ver}/scripts/prepare-kernel.sh --arch=arm --adeos=/dev/null --linux=$KSRC_DIR
+cd %{_builddir}/%{buildsubdir}
+
+# Kernel patches to use GPIOs for monitoring
+#%patch37 -p1
+
+# Patch Xenomai
+cd %{_builddir}/%{x_dir}/%{x_name}-%{x_ver}
+#%patch38 -p1
+cd %{_builddir}/%{buildsubdir}
+
+%patch40 -p1
 
